2)Procedure to list all reservations of a specific client (for example, client_id=1).
DELIMITER //
CREATE PROCEDURE sp_client_reservations(IN p_client_id INT)
BEGIN
 SELECT * FROM bike_rental.reservation WHERE CLIENT_ID = p_client_id;
END
//DELIMITER ;

3)Create a procedure that receives the model_ID (IN) and counts the total number of bicycles of this
model_ID.
DELIMITER //
CREATE PROCEDURE sp_count_bicycles(IN p_model_id INT, OUT p_total INT)
BEGIN
 SELECT COUNT(*) INTO p_total FROM bike_rental.bicycle WHERE MODEL_ID =
p_model_id;
END
// DELIMITER ;

4) Function to calculate rental cost. Input the number of days and the rate, and return days*rate.
DELIMITER //
CREATE FUNCTION fn_calculate_cost(p_days INT, p_rate DECIMAL(10,2))
RETURNS DECIMAL(10,2) DETERMINISTIC
BEGIN
 RETURN p_days * p_rate;
END
// DELIMITER 

5) Function to get client name and address (client with ID=1)
DELIMITER //
CREATE FUNCTION fn_client_full_name(p_client_id INT)
RETURNS VARCHAR(100) DETERMINISTIC
BEGIN
 DECLARE full_name VARCHAR(100);
 SELECT CONCAT(Name, ' - ', address) INTO full_name
 FROM bike_rental.client WHERE CLIENT_ID = p_client_id;
 RETURN full_name;
END
// DELIMITER ;

6) Procedure to create a reservation with a transaction.
DELIMITER //
CREATE PROCEDURE sp_create_reservation(IN p_reservation_id INT, IN p_client_id
INT, IN p_bicycle_id INT, IN p_cost DECIMAL(10,2))
BEGIN
 DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;
 START TRANSACTION;
 INSERT INTO bike_rental.reservation (RESERVATION_ID, CLIENT_CLIENT_ID,
BICYCLE_BICYCLE_ID, RESERVATION_DATE, TOTAL_COST)
 VALUES (p_reservation_id, p_client_id, p_bicycle_id, CURDATE(), p_cost);
 UPDATE bike_rental.bicycle SET STATE=1 WHERE BICYCLE_ID=p_bicycle_id;
 COMMIT;
END
// DELIMITER ;

7) Trigger to prevent double booking.
DELIMITER //
CREATE TRIGGER tr_prevent_double_booking
BEFORE INSERT ON bike_rental.reservation
FOR EACH ROW
BEGIN
 DECLARE bike_state CHAR(1);
 SELECT STATE INTO bike_state FROM bike_rental.bicycle WHERE BICYCLE_ID =
NEW.BICYCLE_BICYCLE_ID;
 IF bike_state = 1 THEN
 SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Bicycle already reserved';
 END IF;
END
// DELIMITER;

8) Trigger to Auto-update bicycle state after reservation delete.
DELIMITER //
CREATE TRIGGER tr_free_bicycle
AFTER DELETE ON bike_rental.reservation
FOR EACH ROW
BEGIN
 UPDATE bike_rental.bicycle
 SET STATE = '0'
 WHERE BICYCLE_ID = OLD.BICYCLE_BICYCLE_ID;
END
// DELIMITER ;

9) Trigger to set default reservation date.
DELIMITER //
CREATE TRIGGER tr_set_default_date
BEFORE INSERT ON bike_rental.reservation
FOR EACH ROW
BEGIN
 IF NEW.RESERVATION_DATE IS NULL THEN
 SET NEW.RESERVATION_DATE = CURDATE();
 END IF;
END
// DELIMITER ;

10) Function + Trigger: Auto-calculate total cost.
DELIMITER //
CREATE FUNCTION fn_compute_total(p_days INT, p_rate DECIMAL(10,2))
RETURNS DECIMAL(10,2) DETERMINISTIC
BEGIN
 RETURN p_days * p_rate;
END
// DELIMITER ;
DELIMITER //
CREATE TRIGGER tr_auto_cost
BEFORE INSERT ON bike_rental.reservation
FOR EACH ROW
BEGIN
 IF NEW.TOTAL_COST IS NULL THEN
 SET NEW.TOTAL_COST = fn_compute_total(
 DATEDIFF(NEW.RETURN_DATE, NEW.DELIVERY_DATE),
 15.00
 );
 END IF;
END
// DELIMITER ;

11) Function to check bicycle availability.
DELIMITER //
CREATE FUNCTION fn_is_bicycle_available(p_bicycle_id INT)
RETURNS TINYINT(1) DETERMINISTIC
BEGIN
 DECLARE st CHAR(1);
 SELECT STATE INTO st
 FROM bike_rental.bicycle
 WHERE BICYCLE_ID = p_bicycle_id;
 RETURN IF(st="1",1,0);
END
// DELIMITER ;

12) Triggers to maintain per-model bicycle count.
ALTER TABLE bike_rental.model ADD COLUMN BICYCLE_COUNT INT DEFAULT 0;
DELIMITER //
CREATE TRIGGER tr_bicycle_add
AFTER INSERT ON bike_rental.bicycle
FOR EACH ROW
BEGIN
 UPDATE bike_rental.model
 SET BICYCLE_COUNT = BICYCLE_COUNT + 1
 WHERE MODEL_ID = NEW.MODEL_MODEL_ID;
END//
DELIMITER ;
DELIMITER //
CREATE TRIGGER tr_bicycle_remove AFTER DELETE ON bike_rental.bicycle
FOR EACH ROW
BEGIN
 UPDATE bike_rental.model
 SET BICYCLE_COUNT = BICYCLE_COUNT - 1
 WHERE MODEL_ID = OLD.MODEL_MODEL_ID;
END //
DELIMITER ;